<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiscaliza.AI - Ficha v9.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 pb-10">
    <div class="max-w-2xl mx-auto bg-white shadow-2xl min-h-screen">
        <header class="bg-blue-900 text-white p-6 text-center">
            <h1 class="text-xl font-bold uppercase">Conselho de AssistÃªncia Social do DF</h1>
            <p class="text-xs opacity-80">Relatoria Processo de InscriÃ§Ã£o - VersÃ£o 9.0</p>
        </header>

        <form id="formFiscalizacao" class="p-6 space-y-8">
            <section class="space-y-4">
                <h2 class="text-blue-800 font-bold border-b-2 border-blue-100 pb-2">1. IdentificaÃ§Ã£o</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="conselheiro" placeholder="Nome do Conselheiro(a)" class="border p-2 rounded w-full" required>
                    <input type="text" id="instituicao" placeholder="Nome da InstituiÃ§Ã£o" class="border p-2 rounded w-full" required>
                    <select id="assunto" class="border p-2 rounded w-full">
                        <option value="inscricao_nova">Pedido de InscriÃ§Ã£o Nova</option>
                        <option value="alteracao_modalidade">AlteraÃ§Ã£o da Modalidade (Anexo I)</option>
                        <option value="acompanhamento">Acompanhamento Anual</option>
                    </select>
                    <input type="date" id="data_visita" class="border p-2 rounded w-full" required>
                </div>
            </section>

            <section class="space-y-4">
                <h2 class="text-blue-800 font-bold border-b-2 border-blue-100 pb-2">2. PÃºblico e Equipe TÃ©cnica</h2>
                <div class="space-y-2">
                    <p class="text-sm font-semibold">PÃºblico-alvo:</p>
                    <div class="flex flex-wrap gap-3">
                        <label class="text-xs bg-gray-50 p-2 rounded border"><input type="checkbox" name="publico" value="Idosos"> Idosos</label>
                        <label class="text-xs bg-gray-50 p-2 rounded border"><input type="checkbox" name="publico" value="Criancas"> CrianÃ§as/Adolesc.</label>
                        <label class="text-xs bg-gray-50 p-2 rounded border"><input type="checkbox" name="publico" value="Familias"> FamÃ­lias</label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs">NÂº Contratados</label>
                        <input type="number" id="n_contratados" class="border p-2 rounded w-full">
                    </div>
                    <div>
                        <label class="text-xs">NÂº VoluntÃ¡rios</label>
                        <input type="number" id="n_voluntarios" class="border p-2 rounded w-full">
                    </div>
                </div>
            </section>

            <section class="space-y-4">
                <h2 class="text-blue-800 font-bold border-b-2 border-blue-100 pb-2">3. Infraestrutura (Item 10)</h2>
                <select id="espaco_tipo" class="border p-2 rounded w-full">
                    <option value="proprio">EspaÃ§o PrÃ³prio</option>
                    <option value="alugado">Alugado</option>
                    <option value="cedido">Cedido pelo GDF</option>
                </select>
                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <label class="block text-xs font-bold mb-2">ðŸ“¸ Capturar EvidÃªncia FotogrÃ¡fica</label>
                    <input type="file" id="inputFoto" accept="image/*" capture="environment" class="text-xs">
                </div>
            </section>

            <section class="space-y-4">
                <h2 class="text-blue-800 font-bold border-b-2 border-blue-100 pb-2">4. ArticulaÃ§Ã£o e ObservaÃ§Ãµes</h2>
                <div class="mb-4">
                    <label class="block text-sm font-bold flex justify-between">
                        Relato por Voz
                        <button type="button" id="btnVoz" class="text-blue-600 text-xs">ðŸŽ¤ Iniciar Microfone</button>
                    </label>
                    <textarea id="observacoes" rows="4" class="w-full p-2 border rounded mt-1" placeholder="Dite as observaÃ§Ãµes tÃ©cnicas..."></textarea>
                </div>
            </section>

            <section class="bg-gray-50 p-4 rounded-xl space-y-4">
                <h2 class="text-center font-bold text-red-700">PARECER DO RELATOR</h2>
                <div class="grid grid-cols-2 gap-2">
                    <label class="text-xs border p-2 bg-white rounded"><input type="radio" name="voto" value="Deferimento"> Deferimento</label>
                    <label class="text-xs border p-2 bg-white rounded"><input type="radio" name="voto" value="Indeferimento"> Indeferimento</label>
                </div>
                <textarea id="fundamentacao" rows="3" class="w-full p-2 border rounded" placeholder="FundamentaÃ§Ã£o tÃ©cnica do voto..."></textarea>
            </section>

            <button type="submit" class="w-full bg-blue-700 text-white font-bold py-4 rounded-lg shadow-xl hover:bg-blue-800 transition">
                ðŸš€ FINALIZAR E SALVAR RELATÃ“RIO
            </button>
        </form>
    </div>

    <script type="module">
        import { db, storage } from './firebase-config.js';
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // LÃ³gica de Voz
        const btnVoz = document.getElementById('btnVoz');
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'pt-BR';
            btnVoz.onclick = () => recognition.start();
            recognition.onresult = (e) => document.getElementById('observacoes').value += e.results[0][0].transcript;
        }

        // Envio Profissional
        document.getElementById('formFiscalizacao').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerText = "Sincronizando com a Nuvem...";

            try {
                let fotoUrl = "";
                const file = document.getElementById('inputFoto').files[0];
                if (file) {
                    const storageRef = ref(storage, `fiscalizacoes/${Date.now()}_${file.name}`);
                    const snap = await uploadBytes(storageRef, file);
                    fotoUrl = await getDownloadURL(snap.ref);
                }

                await addDoc(collection(db, "fiscalisacoes"), {
                    conselheiro: document.getElementById('conselheiro').value,
                    instituicao: document.getElementById('instituicao').value,
                    assunto: document.getElementById('assunto').value,
                    data_visita: document.getElementById('data_visita').value,
                    n_contratados: document.getElementById('n_contratados').value,
                    n_voluntarios: document.getElementById('n_voluntarios').value,
                    espaco_tipo: document.getElementById('espaco_tipo').value,
                    observacoes: document.getElementById('observacoes').value,
                    voto: document.querySelector('input[name="voto"]:checked')?.value,
                    fundamentacao: document.getElementById('fundamentacao').value,
                    foto_evidencia: fotoUrl,
                    timestamp: new Date().toISOString()
                });

                alert("âœ… RelatÃ³rio v9.0 enviado com sucesso!");
                window.location.reload();
            } catch (err) {
                console.error(err);
                alert("Erro ao salvar. Verifique a conexÃ£o.");
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
