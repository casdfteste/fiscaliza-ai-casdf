<div class="mb-6 p-4 bg-blue-50 rounded-lg">
    <label class="block text-sm font-bold text-blue-900 mb-2">ðŸ“¸ DocumentaÃ§Ã£o FotogrÃ¡fica</label>
    <input type="file" id="inputFoto" accept="image/*" capture="environment" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
    <p class="text-xs text-gray-500 mt-2">Tire fotos da fachada, acessibilidade e espaÃ§os.</p>
</div>

<div class="mb-4">
    <label class="block text-sm font-bold text-gray-700 flex justify-between">
        ObservaÃ§Ãµes Gerais
        <button type="button" id="btnVoz" class="text-blue-600 text-xs font-bold">ðŸŽ¤ Falar nota</button>
    </label>
    <textarea id="observacoes" rows="4" class="w-full p-2 border rounded mt-1" placeholder="Relate o que vocÃª observou na visita..."></textarea>
</div>

<script type="module">
    import { db, storage } from './firebase-config.js';
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- LÃ“GICA DE VOZ (Speech to Text) ---
    const btnVoz = document.getElementById('btnVoz');
    const campoObs = document.getElementById('observacoes');

    if ('webkitSpeechRecognition' in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'pt-BR';
        
        btnVoz.onclick = () => {
            recognition.start();
            btnVoz.innerText = "ðŸ”´ Ouvindo...";
        };

        recognition.onresult = (event) => {
            campoObs.value += event.results[0][0].transcript;
            btnVoz.innerText = "ðŸŽ¤ Falar nota";
        };
    }

    // --- ENVIO DO FORMULÃRIO COM FOTO ---
    document.getElementById('formFiscalizacao').addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('inputFoto').files[0];
        let fotoUrl = "";

        // 1. Upload da Foto para o Storage
        if (file) {
            const storageRef = ref(storage, `fotos/${Date.now()}_${file.name}`);
            const snapshot = await uploadBytes(storageRef, file);
            fotoUrl = await getDownloadURL(snapshot.ref);
        }

        // 2. Salva Dados no Firestore
        await addDoc(collection(db, "fiscalizacoes"), {
            conselheiro: document.getElementById('conselheiro').value,
            instituicao: document.getElementById('instituicao').value,
            observacoes: campoObs.value,
            foto_evidencia: fotoUrl,
            data_visita: new Date().toISOString()
        });

        alert("âœ… FiscalizaÃ§Ã£o salva com sucesso!");
    });
</script>

